version: '3.7'
services:
    mongodb:
        image: mongo:latest
        ports:
            - 27017:27017

    camunda:
        image: camunda/camunda-bpm-platform:7.18.0
        ports:
            - 8080:8080
        healthcheck:
            test: curl --fail http://localhost:8080/engine-rest/version || exit 1
            interval: 60s
            retries: 5
            start_period: 20s
            timeout: 10s
        depends_on:
            mongodb:
                condition: service_started

    keycloak:
        image: quay.io/keycloak/keycloak:18.0.0
        command: start-dev --import-realm
        environment:
            KEYCLOAK_ADMIN: admin
            KEYCLOAK_ADMIN_PASSWORD: admin
        ports:
            - 8082:8080
        volumes:
            - ./keycloak/realms:/opt/keycloak/data/import

    camunda-modeler-push:
        build:
            context: ./infra/camunda-model-push
            dockerfile: Dockerfile
        links:
            - camunda
        volumes:
            - ./infra/camunda-model-push/model:/model
        entrypoint: /entrypoint.sh /model camunda:8080            
        depends_on:
            camunda: 
                condition: service_healthy
       
    case-engine-rest-api:
        build:
            context: case-engine-rest-api
        ports:
            - 8081:8081
        links:
            - mongodb
            - camunda
        volumes:
            - ./case-engine-sample-data:/opt/case-engine-sample-data
        environment:
            - MONGO_DATABASE=wks-mongo-database
            - MONGO_CONN=mongodb://mongodb
            - data.import.enabled=true
            - data.import.folder=/opt/case-engine-sample-data
        depends_on:
            camunda:
                condition: service_healthy

    bpm-engine-c7-external-service:
        build:
            context: bpm-engine-c7-external-service
        links:
            - mongodb
            - camunda
        environment:
            - CAMUNDA_BASE_URL=http://camunda:8080/engine-rest
            - CAMUNDA_USERNAME=demo
            - CAMUNDA_PASSWORD=demo
            - MONGO_DATABASE=wks-mongo-database
            - MONGO_CONN=mongodb://mongodb
        depends_on:
            camunda:
                condition: service_healthy

    case-portal-admim:
        build:
            context: case-portal-admin-react
            args:
                REACT_APP_KEYCLOAK_URL: http://localhost:8082
                REACT_APP_API_URL: http://localhost:8081
        ports:
            - 3002:3000

    case-portal:
        build:
            context: case-portal-react
            args:
                REACT_APP_KEYCLOAK_URL: http://localhost:8082
                REACT_APP_API_URL: http://localhost:8081
        ports:
            - 3001:3000